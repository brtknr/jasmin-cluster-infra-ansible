---
heat_template_version: 2016-04-08


description: >
  Top level Cluster-as-a-Service resource for the JASMIN Cloud.


parameters:
  # This is required because yaql isn't available until Newton
  cluster_group_count:
    type: number
    label: The number of node groups in the cluster

  cluster_groups:
    type: json
    label: List of dictionaries defining properties for each node group

  # This should be set automatically by environment.yaml
  cluster_image:
    type: string
    label: The image to use for cluster nodes (must be CentOS 7)
    constraints:
      - custom_constraint: glance.image

  cluster_keypair:
    type: string
    label: SSH key pair for access to the cluster
    constraints:
      - custom_constraint: nova.keypair

  cluster_network:
    type: string
    label: The network to attach cluster nodes to
    constraints:
      - custom_constraint: neutron.network


resources:
  cluster_group:
    type: OS::Heat::ResourceGroup
    properties:
      count: { get_param: cluster_group_count }
      resource_def:
        type: Cluster::Group
        properties:
          cluster_name: { get_param: "OS::stack_name" }
          cluster_groups: { get_param: cluster_groups }
          cluster_image: { get_param: cluster_image }
          cluster_keypair: { get_param: cluster_keypair }
          cluster_network: { get_param: cluster_network }
          group_idx: "%index%"


outputs:
  cluster_group:
    value: { get_attr: [cluster_group, group_data] }
